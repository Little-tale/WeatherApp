//
//  ViewController.swift
//  WeatherApp
//
//  Created by Jae hyung Kim on 2/9/24.
//

import UIKit
import CoreLocation

typealias dateNumDic = [Int:[List]]

// Ïù¥Ï†ú Í≥†ÎØºÌï†Í±¥ Îã§Î•∏ ÏÖÄÎì§ÎèÑ Ïù¥ Î∑∞ÏóêÏÑú ÏÇ¨Ïö©Ìï† Î™®Îç∏Î°ú Î¨∂Ïñ¥ Î≥¥Ïûê. 

final class WeatherMainViewController: UIViewController {
    let locationManager = CLLocationManager()
    let homeView = MainHomeView()
    
    var currentModel: WeatherHomeViewModel? = nil
    
    override func loadView() {
        self.view = homeView
        checkDeviceLocationAuthorization()
    }
    var cityId = 1833788 {
        didSet{
            requestData()
        }
    }
   
    var dateAssistance: DateAssistance = .init(timeZone: 32400)
    
    // Int:[List]
    var dateIndexDictioary = dateNumDic()
    // var dateIndexCecction: [Int:homeSession] = [:]
    
    // MARK: Î°úÏßÅ Í∞úÏÑ† ÏûëÏóÖ 2
    var weatherViewSection : [HomeTableViewSection] = []
    
    // MARK: Ïù¥Í≤ÉÎèÑ Ïôú Ïù¥Î†áÍ≤å ÌñàÏùÑÍπå Í∂ÅÍ∏à
    // var threeModel = [List]()
    
    override func viewDidLoad() {
        super.viewDidLoad()
    
        tableViewRegister()
        requestData()
        
        homeView.tabview.listButton.addTarget(self, action: #selector(goListView), for: .touchUpInside)
    }
    
    
    private func requestData(){
        // MARK: ÌòÑÏû¨ ÎÇ†Ïî® Îç∞Ïù¥ÌÑ∞ ÏöîÏ≤≠
        let group = DispatchGroup()
        
        group.enter()
        URLSessionManager.shared.fetch(type: AllInOneModel.self, api: WeatherApi.currentCity(id: cityId)) { result in
            switch result{
            case .success(let model):
                // print(model)
                self.currentModel = WeatherHomeViewModel(model: model)
              
                self.dateAssistance = DateAssistance(timeZone: model.timezone)
                
            case .failure(let errors):
                print("üßêüßêüßêüßêüßê",errors)
                self.showAlert(error: errors)
            }
            group.leave()
        }
        
        group.enter()
        // MARK: Ï£ºÍ∞Ñ ÎÇ†Ïî® Îç∞Ïù¥ÌÑ∞ ÏöîÏ≤≠
        URLSessionManager.shared.fetch(type: AllInOneModel.self, api: WeatherApi.foreCaseCity(id: cityId)) { result in
            switch result{
            case .success(let success):
                let divideDate = self.dateAssistance.devideCalendar(dateList: success.list)
                switch divideDate {
                case .success(let success):
                    // ÎÇ†ÏßúÎ≥ÑÎ°ú ÎÇòÎâòÏñ¥Ïßê
                    // MARK: Ïù¥ Î°úÏßÅ ÏàòÏ†ïÌïòÎäîÍ≤å Ï¢ãÏùÑÎìØ Ïó¨Í∏∞ÏÑú Î∞îÎ°ú ÏàúÏÑúÏóê ÎßûÍ≤å
                    self.dateIndexDictioary = self.dateAssistance.getSortedIndexList(DateDic: success)
//                    self.dateDictionry = success
                    // self.dateIndexCecction.
                case .failure(let fail):
                    self.showAlert(error: fail)
                }
            case .failure(let error):
                self.showAlert(error: error)
            }
            group.leave()
        }
        
        group.notify(queue: .main) {
            print("üçåüçåüçåüçåüçåüçåüçåüçå")
            guard let current = self.currentModel else {
                return
            }
            // MARK: Î°úÏßÅÍ∞úÏÑ† 4 -> ÌÜµÌï© Î™®Îç∏Î°ú Î≥ÄÍ≤ΩÌõÑ Ïû¨ÏãúÎèÑ
            /// Í∞Å ÏÉâÏÖòÎ≥ÑÎ°ú Î™®Îç∏ÏùÑ Íµ¨Î∂ÑÏúÑÌï®
            // self.logicUpdateSection(currentModel: current, forecastModel:  self.threeItems())
            self.homeView.tableView.reloadData()
        }
        
      
        
        
    }
    // MARK: Î°úÏßÅ Í∞úÏÑ† ÏûëÏóÖ 3
//    func logicUpdateSection(currentModel: WeatherHomeViewModel, forecastModel: [List]) {
//        self.weatherViewSection = [
//            .currentWeather(currentModel),
//            .threeDatForecast(forecastModel),
//            .detailInfo(currentModel)
//        ]
//    }
    
    
    
    // MARK: Îã§ÏùåÎ∑∞Î°ú Í∞ÄÏÑú Í∞íÏùÑ Í∞ÄÏ†∏ÏòµÎãàÎã§.
    @objc
    func goListView(){
        let vc = CityListViewController()
        vc.getCityId = {
            cityId in
            self.cityId = cityId
        }
        present(vc, animated: true)
    }
    
    
    
    // MARK: ÌÖåÏù¥Î∏îÎ∑∞ ÎîúÎ¶¨Í≤åÏù¥Ìä∏ Îç∞Ïù¥ÌÉÄ ÏÜåÏä§ + Ïò§ÌÜ†Î†àÏù¥ÏïÑÏõÉ
    func tableViewRegister(){
        homeView.tableView.delegate = self
        homeView.tableView.dataSource = self
        homeView.tableView.rowHeight = UITableView.automaticDimension
        homeView.tableView.estimatedRowHeight = 120
    }
    
    override func viewDidAppear(_ animated: Bool) {
        super.viewDidAppear(animated)
        // homeView.tableView.layoutIfNeeded()
    }
    //MARK: 3ÏùºÏπò Îç∞Ïù¥ÌÑ∞Î•º Î∞òÌôòÌï¥Ï§çÎãàÎã§.
    private func threeItems() -> [List] {
        // ÌÇ§ 0,1,2,3,4 .... Ï≤òÎüº Ï†ïÎ†¨
        let sortedKey = dateIndexDictioary.keys.sorted()
        // ÏïûÏóêÏÑú 3Í∞úÎßå Í∞ÄÏ†∏Ïò¨Í≤®
        let threeTimes = sortedKey.prefix(3)
        // [0, 1, 2] -> 3ÏùºÏπò ÏûÑ
        // print(threeTimes)
        let threeTimeItems = threeTimes.compactMap { myKey in
            dateIndexDictioary[myKey]
        }
        // dump(threeTimeItems)
        var totalItem = [List]()
        threeTimeItems.forEach { list in
            totalItem.append(contentsOf: list)
        }
        return totalItem
    }
    
}
// MARK: ÌÖåÏù¥Î∏îÎ∑∞ Îç∞Ïù¥ÌÉÄ
extension WeatherMainViewController : UITableViewDelegate, UITableViewDataSource {
    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        return homeSession.allCases.count
    }
    
    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {

        let section = homeSession.allCases[indexPath.row]
        // let totalItems = threeItems()
    
        // threeModel = totalItems
        // print("asdasdasdasd")
        switch section {
        case .threeTimeInterval:
            // print(secction)
            guard let cell = tableView.dequeueReusableCell(withIdentifier: MainHomeTableViewCell.reusableIdentifier, for: indexPath) as? MainHomeTableViewCell else {
                print("ÏÖÄ Î≥ÄÌôò Ïã§Ìå®")
                return UITableViewCell()
            }
            cell.collectionView.delegate = self
            cell.collectionView.dataSource = self
            cell.topView.label.text = section.title
            cell.backgroundColor = .clear
            cell.collectionView.reloadData()

            return cell
            
        case .fiveDayaInterval:
            guard let cell = tableView.dequeueReusableCell(withIdentifier: FiveDayIntervalTableCell.reusableIdentifier) as? FiveDayIntervalTableCell else {
                print("ÏÖÄ Î≥ÄÌôòÏã§Ìå® FiveDayIntervalTableCell")
                return UITableViewCell()
            }
            cell.fiveDelegate = self
            cell.label.label.text = section.title
            cell.tableView.reloadData()
            return cell
            
        case .location:
            guard let cell = tableView.dequeueReusableCell(withIdentifier: LocationTableViewCell.reusableIdentifier, for: indexPath) as? LocationTableViewCell else {
                print("ÏÖÄ Î≥ÄÌôòÏã§Ìå® LocationTableViewCell")
                return UITableViewCell()
            }
            cell.header.label.text = section.title
            cell.header.imageView.image = UIImage(systemName: "location.fill")
            guard let current = currentModel?.coord else {
                print("Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§ currentModel -> coord")
                return cell
            }
            cell.settingLocattion(lat: current.lat, lon: current.lon)
            guard let currentData = currentModel else {
                print("Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§ currentModel -> currentData")
                return cell
            }
            
            cell.setModelData(model: currentData)
            return cell
        }
        // return cell
    }
    
    func tableView(_ tableView: UITableView, viewForHeaderInSection section: Int) -> UIView? {
        guard let model = currentModel else {
            print("Î™®Îç∏Ïù¥ ÏóÜÏùå.")
            return UIView()
        }
        let currentView = CurrentWeatherHeaderView()
        currentView.settingView(city: model.cityName, temp: model.temperature, weatherInfo: model.description, maxTemp: model.maxTemp, minTemp: model.minTemp)
        return currentView
    }
    // MARK: ÌÖåÏù¥Î∏îÎ∑∞ÏÖÄ ÌÅ¨Í∏∞
    func tableView(_ tableView: UITableView, heightForRowAt indexPath: IndexPath) -> CGFloat {
        return UITableView.automaticDimension
    }
    // MARK: Ìó§ÎçîÎ∑∞ ÌÅ¨Í∏∞
    func tableView(_ tableView: UITableView, heightForHeaderInSection section: Int) -> CGFloat {
        // Ìó§ÎçîÎ∑∞ ÎèôÏ†ÅÍ≥ÑÏÇ∞ Ìè¨Í∏∞ ÏóÜÏñ¥Ï°åÎã§ ÏÉùÍ∏∞Îäî Í≥ºÏ†ïÏóêÏÑú ÏûêÎèôÏ†ÅÏùºÎñÑ 24 Ïó¨Ïïº ÌïúÎã§ÏôÄ ÎÇ¥Î∂Ä Ï†ÅÏúºÎ°† Îçî Ïª§Ïïº ÌïúÎã§Í∞Ä Ï∂©ÎèåÎê®
        return 240
    }
    
    
}
// MARK: Ïª¨Î†âÏÖòÎ∑∞ Îç∞Ïù¥ÌÉÄ
extension WeatherMainViewController: UICollectionViewDelegate, UICollectionViewDataSource {
    func collectionView(_ collectionView: UICollectionView, numberOfItemsInSection section: Int) -> Int {
        return threeItems().count
    }
    
    func collectionView(_ collectionView: UICollectionView, cellForItemAt indexPath: IndexPath) -> UICollectionViewCell {
        guard let cell = collectionView.dequeueReusableCell(withReuseIdentifier: TimesWeatherCollecionViewCell.reusableIdentifier, for: indexPath) as? TimesWeatherCollecionViewCell else {
            print("Ïª¨Î†âÏÖòÎ∑∞ ÏÖÄ ÏóêÎü¨")
            return UICollectionViewCell()
        }
        
        let modelData = threeItems()[indexPath.row]

        cell.settingCellElements(list: modelData, dateAssi: dateAssistance, image: modelData.weather.first?.icon)
    
        return cell
        
    }
}

extension WeatherMainViewController: FiveDayIntervalProtocol {
    func FivetableView(for FiveDayIntervalTableCell: UITableViewCell, tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        print("ü•ùü•ùü•ùü•ùü•ùü•ù",dateIndexDictioary.count)
        return dateIndexDictioary.count
    }
    
    func FivetableView(for FiveDayIntervalTableCell: UITableViewCell, tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        guard let cell = tableView.dequeueReusableCell(withIdentifier: FiveInnerTableViewCell.reusableIdentifier , for: indexPath) as? FiveInnerTableViewCell else {
            print("FiveInnerTableViewCell Î≥ÄÌôò Ïã§Ìå®")
            return UITableViewCell()
        }
        
        guard let representList = dateIndexDictioary[indexPath.row] else {
            print("Îç∞Ïù¥ÌÑ∞ Î∞õÍ∏∞ Ïã§Ìå® dateIndexDictioary")
            return cell
        }
        
        guard let represent = representList.first else {
            print("ÎåÄÌëú Î∞õÍ∏∞ Ïã§Ìå®")
            return cell
        }
        
        cell.settingImage(imageName: represent.weather.first?.icon ?? "")
        
        let dateWeekText = dateAssistance.getDayOfWeek(dtText: represent.dtTxt)
        
        let maxText = TemperatureAssistance.max(representList).getAverage
        
        let minText = TemperatureAssistance.min(representList).getAverage

        cell.settingLabelsText(dateWeek: dateWeekText, maxText: maxText, minText: minText)
        return cell
    }
    
    
}

//#Preview{
//    WeatherMainViewController()
//}
// MARK: Ìï¥Îãπ Î≥ÄÏàòÏóê Ïì∏Î™®Í∞Ä ÏóÜÏùå
//    var dateDictionry = dateDictionryForString() {
//        didSet{
//            dateIndexDictioary = dateAssistance.getSortedIndexList(DateDic: dateDictionry)
//        }
//    }
// [Int:[List]]

// MARK: ÌÜµÌï©Î™®Îç∏ ÌÖåÏä§Ìä∏ Íµ¨Ïó≠
// ÌÜµÏã† ÌÖåÏä§Ìä∏ 1Ï∞® ÌÜµÍ≥º -> currentCity ÏïàÎêòÎäîÏ§ë
// 2Ï∞® ÌÜµÍ≥º ÏïåÍ≥†Î≥¥Îãà ÎÇ†ÏßúÎ•º ÎÇòÎàå ÌïÑÏöîÍ∞Ä ÏóÜÏóàÏùå. Í∑∏ÎûòÏÑú ÎÇ†ÏßúÎ•º ÎÇòÎàÑÎäî Î©îÏÑúÎìúÏóêÏÑú ÌÑ∞ÏßÑÍ±∞ÏòÄÏùå
// 3Ï∞® Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏ ÌÜµÍ≥º
// 4Ï∞® Îç∞Ïù¥ÌÑ∞ ÌÜµÍ≥º
